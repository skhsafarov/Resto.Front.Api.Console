# Publish to NuGet.org using Trusted Publishing
# This script is for manual publishing. For automated publishing, use GitHub Actions.

param(
    [string]$ApiKey
)

$packagePath = ".\PackageOutput\Resto.Front.Api.Console.1.0.0.nupkg"

Write-Host "`n??????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "?           ?? ?????????? ?? NUGET.ORG                       ?" -ForegroundColor Cyan
Write-Host "??????????????????????????????????????????????????????????????" -ForegroundColor Cyan

# Check if package exists
if (-not (Test-Path $packagePath)) {
    Write-Host "`n? ????? ?? ??????!" -ForegroundColor Red
    Write-Host "   ????: $packagePath" -ForegroundColor Gray
    Write-Host "`n???????? ????? ????????: .\build.ps1`n" -ForegroundColor Yellow
    exit 1
}

$pkg = Get-Item $packagePath
Write-Host "`n? ????? ??????:" -ForegroundColor Green
Write-Host "   ???:    $($pkg.Name)" -ForegroundColor White
Write-Host "   ??????: $([math]::Round($pkg.Length/1KB,2)) KB" -ForegroundColor White

Write-Host "`n?? ???????? ??????????:`n" -ForegroundColor Yellow

Write-Host "??????? 1: Trusted Publishing ????? GitHub Actions (?????????????)" -ForegroundColor Cyan
Write-Host "   1. ??????????? ?????????:" -ForegroundColor White
Write-Host "      git add ." -ForegroundColor Gray
Write-Host "      git commit -m 'Release v1.0.0'" -ForegroundColor Gray
Write-Host "      git tag v1.0.0" -ForegroundColor Gray
Write-Host "      git push origin master --tags" -ForegroundColor Gray
Write-Host "   2. GitHub Actions ????????????? ?????????? ?????!" -ForegroundColor Green
Write-Host ""

Write-Host "??????? 2: ?????? ?????????? ? API ??????" -ForegroundColor Cyan

if ([string]::IsNullOrEmpty($ApiKey)) {
    Write-Host "   ???????? API ????: https://www.nuget.org/account/apikeys" -ForegroundColor White
    Write-Host "   ????? ?????????:" -ForegroundColor White
    Write-Host "   .\publish.ps1 -ApiKey `"???-api-????`"`n" -ForegroundColor Gray
} else {
    Write-Host "`n?? ?????????? ?? NuGet.org..." -ForegroundColor Yellow
    
    try {
        dotnet nuget push $packagePath --api-key $ApiKey --source https://api.nuget.org/v3/index.json
        
        if ($LASTEXITCODE -eq 0) {
            Write-Host "`n??????????????????????????????????????????????????????????????" -ForegroundColor Green
            Write-Host "?              ?? ??????? ????????????! ??                   ?" -ForegroundColor Green
            Write-Host "??????????????????????????????????????????????????????????????" -ForegroundColor Green
            
            Write-Host "`n? ????? ????????? ?? NuGet.org" -ForegroundColor Green
            Write-Host "? ????? ????? ???????? ????? 5-10 ?????" -ForegroundColor Yellow
            Write-Host "?? ?????????: https://www.nuget.org/packages/Resto.Front.Api.Console/" -ForegroundColor Cyan
            
            Write-Host "`n?? ?? ???????? ??????? git tag:" -ForegroundColor Yellow
            Write-Host "   git tag v1.0.0" -ForegroundColor Gray
            Write-Host "   git push --tags`n" -ForegroundColor Gray
        } else {
            Write-Host "`n? ?????? ??????????!" -ForegroundColor Red
            exit 1
        }
    } catch {
        Write-Host "`n? ??????????? ??????: $_" -ForegroundColor Red
        exit 1
    }
}
